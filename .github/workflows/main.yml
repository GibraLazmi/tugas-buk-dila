name: PHP CI - Lint & Smoke Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  php-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, mysqli, pdo_mysql
          ini-values: post_max_size=256M, upload_max_filesize=256M

      - name: PHP lint (syntax check)
        run: |
          set -e
          # fail fast on any syntax error
          find . -type f -name "*.php" -print0 | xargs -0 -n1 php -l

      - name: Start server and run smoke tests
        run: |
          set -e
          # start built-in server in background, serve folder 'login'
          nohup php -S 0.0.0.0:8000 -t login > server.log 2>&1 &
          SERVER_PID=$!
          echo "Started php server with PID $SERVER_PID"
          # wait until server responds or timeout
          for i in $(seq 1 15); do
            if curl -sSf http://127.0.0.1:8000/signup.php >/dev/null 2>&1; then
              echo "Server is up (attempt $i)."
              break
            fi
            echo "Waiting for server to be ready (attempt $i)..."
            sleep 1
          done
          # show server log for debugging
          echo "===== server.log (tail) ====="
          tail -n 200 server.log || true
          # run smoke tests (uses tests/smoke.sh)
          bash tests/smoke.sh
